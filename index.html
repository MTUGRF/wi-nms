<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Wisconsin National Marine Sanctuary Web Map</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.31/"></script>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }

      #layerToggle {
        top: 20px;
        right: 20px;
        position: absolute;
        z-index: 99;
        background-color: white;
        border-radius: 8px;
        padding: 10px;
        opacity: 0.75;
      }


    </style>

    <script>
      require(["esri/WebMap", "esri/views/MapView", "esri/layers/TileLayer", "esri/layers/FeatureLayer", "esri/core/reactiveUtils", "esri/Graphic", "esri/layers/GeoJSONLayer"], (WebMap, MapView, TileLayer, FeatureLayer, reactiveUtils, Graphic, GeoJSONLayer) => {   

      const cameraModal = new bootstrap.Modal('#cameraModal', {
        keyboard: false
      }) 

          
      // layer renderers
       // Create a renderer for point features
  const buoyRenderer = {
    type: "simple", // Use a simple renderer
    symbol: {
      type: "simple-marker", // For points, use simple-marker
      style: "circle", // Marker shape (e.g., circle, square, diamond)
      color: "blue", // Fill color
      size: "10px", // Size of the marker
      outline: { // Outline for the marker
        color: "white",
        width: 1
      }
    }
  }
        // Define a pop-up for beachCameraLayer
          const popupBeachCameras = {
            title: "{name}",
            content:
              '<iframe src="https://www.google.com" title="{name}" height="200" width="300"></iframe>'
          };

          // Define a pop-up for beachCameraLayer
          let sofarInfo = {
            title: "{spotterName}",
            content:
              '<iframe src="https://www.google.com" title="{name}" height="200" width="300"></iframe>'
          };

          // Define a pop-up for beachCameraLayer
          let popupStations = {
            title: "{name}",
            content:
              '<iframe src="https://www.google.com" title="{name}" height="200" width="300"></iframe>'
          };

         const ndbcLayer = new FeatureLayer({
          url: "https://services2.arcgis.com/RPhrOu9XQzI31xTa/arcgis/rest/services/WI_Marine/FeatureServer",
          // This property can be used to uniquely identify the layer
          id: "ndbc",
          visible: true,
          outFields: ["*"],
          popupTemplate: popupStations
        });

        const beachCameraLayer = new FeatureLayer({
          url: "https://services2.arcgis.com/RPhrOu9XQzI31xTa/arcgis/rest/services/Beach_Cameras/FeatureServer",
          id: "beach-cameras",
          visible: true,
          outFields: ["*"],
          popupTemplate: popupBeachCameras
        });

        const trafficLightLayer = new FeatureLayer({
          url: "https://services2.arcgis.com/RPhrOu9XQzI31xTa/arcgis/rest/services/Beach_Traffic_Lights/FeatureServer", 
          outFields: ["*"], // Load all fields
          visible: false,
          popupTemplate: { // Basic popup setup; dynamic updates will override this
            title: "{Name}",
            content: "Loading..."
          }
        });

        const sofarLayer = new GeoJSONLayer({
          url: "https://geospatialresearch.mtu.edu/nms-wi/sofar-latest/sofarbuoys.php",
          copyright: "sofarocean",
          id: "sofar",
          renderer: buoyRenderer,
          outFields: ["*"],
          popupTemplate: sofarInfo
        });
        
        const webmap = new WebMap({
          portalItem: { // autocasts as new PortalItem()
            id: "1143fa1055ac4afaac271f9c5ca33c48"
          }
        });

        const view = new MapView({
          container: "viewDiv",
          map: webmap          
        });

        webmap.add(beachCameraLayer, 0);
        webmap.add(ndbcLayer, 0);
        webmap.add(trafficLightLayer, 0);
        webmap.add(sofarLayer, 0);


   /*       // Add a click event listener to the map view
  view.on("click", function(event) {
    // Get map coordinates (longitude and latitude) from the clicked point
    const lat = event.mapPoint.latitude.toFixed(6); 
    const lon = event.mapPoint.longitude.toFixed(6); 
    // query NOAA weather API for the current forcast for this area
    // forecast for Marine zones not yet supported. 
     fetch("https://api.weather.gov/points/" + lat + "," + lon)
          .then((response) => response.json())
          .then((data) => {
            console.log(data.properties);

             fetch("https://marine.weather.gov/MapClick.php?lat=44.0997&lon=-87.6136")
              .then((response) => response.text())
              .then((data) => {
                console.log(data);
            });
          });

   /* // Set the popup content and location
    view.popup.open({
      // Popup content
      title: "Coordinates",
      content: `Latitude: ${lat}<br>Longitude: ${lon}`,
      location: event.mapPoint // Location of the popup
    });
  });*/

         // Query the feature layer when it loads
  trafficLightLayer.when(() => {
    // Fetch all features
    trafficLightLayer.queryFeatures({
      where: "1=1", // Get all features
      outFields: ["*"],
      returnGeometry: true
    }).then((result) => {
      const features = result.features;

      // Process each feature to query the endpoint
      features.forEach((feature) => {
        const streamUrl = feature.attributes.stream_URL; // Get Stream_URL field

        // Fetch the JSON data from the endpoint
        fetch("https://geospatialresearch.mtu.edu/nms-wi/trafficlights/" + streamUrl)
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
            const value = data.list[0].value;
            const lastUpdate = data.list[0].timestamp;
            const color = getColor(value);
            const popupText = getPopupText(value);

            // Update the symbol and popup content
            const updatedGraphic = new Graphic({
              geometry: feature.geometry,
              attributes: feature.attributes,
              symbol: {
                type: "simple-marker",
                color: color,
                size: "12px",
                outline: {
                  color: "#000",
                  width: 1
                }
              },
              popupTemplate: {
                title: "{Name}",
                content: popupText + "<br><br> Last Updated: " + lastUpdate
              }
            });

            // Add updated graphic to the map
            view.graphics.add(updatedGraphic);
          })
          .catch((err) => console.error("Error fetching data:", err));
           // Set default white light and "Unknown" status
      const errorGraphic = new Graphic({
        geometry: feature.geometry,
        attributes: feature.attributes,
        symbol: {
          type: "simple-marker",
          color: "white", // Default color for errors
          size: "12px",
          outline: {
            color: "#000",
            width: 1
          }
        },
        popupTemplate: {
          title: "{Name}",
          content: "Unknown status"
        }
      });

      // Add error graphic to the map
      view.graphics.add(errorGraphic);
      });
    });
  });

  // Helper function to get color based on value
  function getColor(value) {
    switch (value) {
      case "0": return "gray";
      case "1": return "red";
      case "2": return "yellow";
      case "3": return "green";
      case "6": return "darkred";
      default: return "white"; // Fallback color
    }
  }

  // Helper function to get popup text based on value
  function getPopupText(value) {
    switch (value) {
      case "0": return "The Light is turned off.";
      case "1": return "High Hazard: Strong currents and/or high waves and/or contamination.";
      case "2": return "Medium Hazard: Moderate currents and/or waves and/or contamination.";
      case "3": return "Calm conditions, exercise caution. ";
      case "6": return "Water Closed: No Swimming Allowed. Water closed to the public.";
      default: return "Unknown status";
    }
  }



        fetch("https://api.sofarocean.com/api/latest-data?spotterId=SPOT-30949C&includeSurfaceTempData=true&token=ddeec47c3c3f59bf757c6087630e6c")
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                    });

        // what the popup for a selected feature 
        reactiveUtils.watch(
          () => view.popup.selectedFeature,
          (graphic) => {
            if (graphic) {
                console.log(graphic);
                if (graphic.layer.id === "beach-cameras") {                     
                  const cameraName = graphic.attributes.name;
                  const cameraUrl = graphic.attributes.url;
                  console.log(cameraUrl);
                  document.getElementById("cameraFrame").src = cameraUrl; 
                  document.getElementById("cameraTitle").textContent = cameraName;   
                  cameraModal.show();               
                } else if (graphic.layer.id == "sofar") {
                  console.log("sofar",graphic);

                  const buoyId = graphic.attributes.spotterId;
const buoyName = graphic.attributes.spotterName;
const lastUpdated = graphic.attributes.timestamp
    ? new Date(graphic.attributes.timestamp).toLocaleString()
    : "No Data";
const waveHeight = graphic.attributes.significantWaveHeight ?? "No Data";
const peakDir = graphic.attributes.peakDirection ?? "No Data";
const peakPeriod = graphic.attributes.peakPeriod ?? "No Data";

// Fetch temperature data from the API
fetch("https://api.sofarocean.com/api/sensor-data?spotterId=SPOT-30363R&startDate=2024-12-01T07:00:00Z&endDate=2024-12-02T07:00:00&token=9b5b0e8377a2805157c883a7f9d7b3")
    .then(response => response.json())
    .then(data => {
        console.log("tempdata:", data);

        // Helper function to handle missing data
        const getValueOrNoData = (value, unit = "") => {
            return value !== null && value !== undefined ? `${value.toFixed(2)} ${unit}` : "No Data";
        };

        // Extract temperature and pressure data
        const surfWaterTemp = getValueOrNoData(data.data[0]?.value, "°C");
        const Water15Temp = getValueOrNoData(data.data[1]?.value, "°C");
        const Water25Temp = getValueOrNoData(data.data[2]?.value, "°C");
        const bPress = getValueOrNoData(data.data[3]?.value, "μbar");
        const Water35Temp = getValueOrNoData(data.data[4]?.value, "°C");
        const bottomPress = getValueOrNoData(data.data[5]?.value, "μbar");
        const tempUpdated = data.data[0]?.timestamp
            ? new Date(data.data[0].timestamp).toLocaleString()
            : "No Data";

        // Create the popup content using HTML tables
        const popupContent = `
            <h5>Wave Information</h5>
            <table style="width:100%; border-collapse: collapse; text-align: left; margin-bottom: 15px;">
                <tr>
                    <th style="border-bottom: 1px solid #ddd; padding: 8px;">Attribute</th>
                    <th style="border-bottom: 1px solid #ddd; padding: 8px;">Value</th>
                </tr>
                <tr>
                    <td style="padding: 8px;">Buoy ID</td>
                    <td style="padding: 8px;">${buoyId}</td>
                </tr>
                <tr>
                    <td style="padding: 8px;">Buoy Name</td>
                    <td style="padding: 8px;">${buoyName}</td>
                </tr>
                <tr>
                    <td style="padding: 8px;">Last Updated</td>
                    <td style="padding: 8px;">${lastUpdated}</td>
                </tr>
                <tr>
                    <td style="padding: 8px;">Significant Wave Height</td>
                    <td style="padding: 8px;">${waveHeight} m</td>
                </tr>
                <tr>
                    <td style="padding: 8px;">Peak Direction</td>
                    <td style="padding: 8px;">${peakDir}°</td>
                </tr>
                <tr>
                    <td style="padding: 8px;">Peak Period</td>
                    <td style="padding: 8px;">${peakPeriod} s</td>
                </tr>
            </table>

            <h5>Water Temperature and Pressure Information</h5>
            <table style="width:100%; border-collapse: collapse; text-align: left;">
                <tr>
                    <th style="border-bottom: 1px solid #ddd; padding: 8px;">Attribute</th>
                    <th style="border-bottom: 1px solid #ddd; padding: 8px;">Value</th>
                </tr>
                <tr>
                    <td style="padding: 8px;">Surface Water Temperature (1 meter)</td>
                    <td style="padding: 8px;">${surfWaterTemp}</td>
                </tr>
                <tr>
                    <td style="padding: 8px;">Water Temperature (15 meters)</td>
                    <td style="padding: 8px;">${Water15Temp}</td>
                </tr>
                <tr>
                    <td style="padding: 8px;">Water Temperature (25 meters)</td>
                    <td style="padding: 8px;">${Water25Temp}</td>
                </tr>
                <tr>
                    <td style="padding: 8px;">Water Temperature (35 meters)</td>
                    <td style="padding: 8px;">${Water35Temp}</td>
                </tr>
                <tr>
                    <td style="padding: 8px;">Barometric Pressure</td>
                    <td style="padding: 8px;">${bPress}</td>
                </tr>
                <tr>
                    <td style="padding: 8px;">Lake Bottom Pressure</td>
                    <td style="padding: 8px;">${bottomPress}</td>
                </tr>
                <tr>
                    <td style="padding: 8px;">Temperature Data Last Updated</td>
                    <td style="padding: 8px;">${tempUpdated}</td>
                </tr>
            </table>
        `;

        // Create a template for the popup
        sofarInfo = {
            title: "{spotterName}",
            content: popupContent
        };

        sofarLayer.popupTemplate = sofarInfo;
                 }) 
                } else if (graphic.layer.id == "ndbc") {
                  const stationId = graphic.attributes.STATION_ID;
                  const stationName = graphic.attributes.NAME;
                  const stationUrl = graphic.attributes.URL; 
                  const stationType = graphic.attributes.TTYPE;
                  const stationOwner = graphic.attributes.OWNER; 
                  console.log(stationId, stationUrl);

                  // use the station ID to query the NDBC for observations
                  const url = 'https://www.ndbc.noaa.gov/get_observation.php?station=' + stationId +'&fmt=json';
                  const encodedUrl = 'https://api.codetabs.com/v1/proxy/?quest=' + encodeURIComponent(url);
                  fetch(encodedUrl)
                    .then(response => response.json())
                    .then(data => {
                        
                      console.log(data);                   
                      if (data.observation.msg == null) {
                        const airTemp = data.observation.data.airtemp.value;
                        const lastUpdated = data.observation.data.datetime.iso8601;
                        const dewPoint = data.observation.data.dewpoint.value;
                        const meanWaveDir = data.observation.data.meanwavedir.value;
                        const pressure = data.observation.data.pressure.value;
                        const pressureTend = data.observation.data.pressuretendency.value;
                        const tide = data.observation.data.tide.value;
                        const visibility = data.observation.data.visibility.value;
                        const waterTemp = data.observation.data.watertemp.value;
                        const waveHeight = data.observation.data.waveht.value;
                        const windDir = data.observation.data.winddir.value;
                        const windGust = data.observation.data.windgust.value;
                        const windSpeed = data.observation.data.windspeed.value;
                        


                        // Create a template for the popup
                        popupStations = {
                          title: stationName,
                          content:                            
                            '<b>Station Type: </b>' + stationType + '<br><br>' +
                            '<b>Station Owner: </b>' + stationOwner + '<br><br>' +
                            '<b>Last Updated: </b>' + lastUpdated + '<br><br>' +
                            '<b>Air temperature: </b>' + airTemp + ' (°F)<br><br>' +
                            '<b>Dew Point: </b>' + dewPoint + ' (°F)<br>' +                            
                            '<b>Mean Wave Direction</b> ' + meanWaveDir + data.observation.data.meanwavedir.text + " (def) <br><br>" +  
                            '<b>Wave Height: </b>' + waveHeight + ' (ft)<br>' +                             
                            '<b>Pressure: </b>' + pressure + ' (in)<br>' +  
                            '<b>Pressure Tendency: </b>' + pressureTend + '<br>' + 
                            '<b>Tide: </b>' + tide + ' (ft)<br>' +     
                            '<b>Visibility: </b>' + visibility + ' (nmi)<br>' + 
                            '<b>Water Temperature: </b>' + waterTemp + ' (°F)<br>' +
                            '<b>Wind Speed: </b>' + windSpeed + ' (kt)<br>' + 
                            '<b>Wind Gust: </b>' + windGust + ' (kt)<br>' +  
                            '<b>Wind Direction: </b>' + windDir +  data.observation.data.winddir.text + ' (deg)<br>' 

                        }

                        ndbcLayer.popupTemplate = popupStations;
                      } else if (data.observation.msg == "No data") {
                        // Create a template for the popup
                        popupStations = {
                          title: stationName,
                          content:                            
                            '<b>Station Type: </b>' + stationType + '<br><br>' +
                            '<b>Station Owner: </b>' + stationOwner + '<br><br>' +
                            'This station is currently not sending any data'
                        }

                        ndbcLayer.popupTemplate = popupStations;
                      }
                    });
                }
            }
        });        
      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
    <span id="layerToggle" class="esri-widget"> <input type="checkbox" id="streetsLayer" /> Transportation </span>
    <div class="modal" tabindex="-1" id="cameraModal">
  <div class="modal-dialog .modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cameraTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <iframe src="" title="description" id="cameraFrame" width="100%"></iframe> 
      </div>      
    </div>
  </div>
</div>
  </body>
</html>
